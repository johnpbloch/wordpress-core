var wpLink;!function(t,e,i){function s(){return d||r.dom.getParent(r.selection.getNode(),"a[href]")}var r,n,a,o,h,d,c=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,63}$/i,l=/^(https?|ftp):\/\/[A-Z0-9.-]+\.[A-Z]{2,63}[^ "]*$/i,u={},p={},m="ontouchend"in document;wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",modalOpen:!1,init:function(){u.wrap=t("#wp-link-wrap"),u.dialog=t("#wp-link"),u.backdrop=t("#wp-link-backdrop"),u.submit=t("#wp-link-submit"),u.close=t("#wp-link-close"),u.text=t("#wp-link-text"),u.url=t("#wp-link-url"),u.nonce=t("#_ajax_linking_nonce"),u.openInNewTab=t("#wp-link-target"),u.search=t("#wp-link-search"),p.search=new a(t("#search-results")),p.recent=new a(t("#most-recent-results")),p.elements=u.dialog.find(".query-results"),u.queryNotice=t("#query-notice-message"),u.queryNoticeTextDefault=u.queryNotice.find(".query-notice-default"),u.queryNoticeTextHint=u.queryNotice.find(".query-notice-hint"),u.dialog.keydown(wpLink.keydown),u.dialog.keyup(wpLink.keyup),u.submit.click(function(t){t.preventDefault(),wpLink.update()}),u.close.add(u.backdrop).add("#wp-link-cancel button").click(function(t){t.preventDefault(),wpLink.close()}),p.elements.on("river-select",wpLink.updateFields),u.search.on("focus.wplink",function(){u.queryNoticeTextDefault.hide(),u.queryNoticeTextHint.removeClass("screen-reader-text").show()}).on("blur.wplink",function(){u.queryNoticeTextDefault.show(),u.queryNoticeTextHint.addClass("screen-reader-text").hide()}),u.search.on("keyup input",function(){window.clearTimeout(n),n=window.setTimeout(function(){wpLink.searchInternalLinks()},500)}),u.url.on("paste",function(){setTimeout(wpLink.correctURL,0)}),u.url.on("blur",wpLink.correctURL)},correctURL:function(){var e=t.trim(u.url.val());e&&h!==e&&!/^(?:[a-z]+:|#|\?|\.|\/)/.test(e)&&(u.url.val("http://"+e),h=e)},open:function(e,i,s,n){var a,o=t(document.body);o.addClass("modal-open"),wpLink.modalOpen=!0,d=n,wpLink.range=null,e&&(window.wpActiveEditor=e),window.wpActiveEditor&&(this.textarea=t("#"+window.wpActiveEditor).get(0),"undefined"!=typeof window.tinymce&&(o.append(u.backdrop,u.wrap),a=window.tinymce.get(window.wpActiveEditor),r=a&&!a.isHidden()?a:null),!wpLink.isMCE()&&document.selection&&(this.textarea.focus(),this.range=document.selection.createRange()),u.wrap.show(),u.backdrop.show(),wpLink.refresh(i,s),t(document).trigger("wplink-open",u.wrap))},isMCE:function(){return r&&!r.isHidden()},refresh:function(t,e){p.search.refresh(),p.recent.refresh(),wpLink.isMCE()?wpLink.mceRefresh(t,e):(u.wrap.hasClass("has-text-field")||u.wrap.addClass("has-text-field"),document.selection?document.selection.createRange().text||e||"":"undefined"!=typeof this.textarea.selectionStart&&this.textarea.selectionStart!==this.textarea.selectionEnd&&(e=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd)||e||""),u.text.val(e),wpLink.setDefaultValues()),m?u.url.focus().blur():window.setTimeout(function(){u.url[0].select(),u.url.focus()}),p.recent.ul.children().length||p.recent.ajax(),h=u.url.val().replace(/^http:\/\//,"")},hasSelectedText:function(t){var e,i,s,n=r.selection.getContent();if(/</.test(n)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(n)||-1===n.indexOf("href=")))return!1;if(t){if(i=t.childNodes,0===i.length)return!1;for(s=i.length-1;s>=0;s--)if(e=i[s],3!=e.nodeType&&!window.tinymce.dom.BookmarkManager.isBookmarkNode(e))return!1}return!0},mceRefresh:function(i,n){var a,o,h=s(),d=this.hasSelectedText(h);h?(a=h.textContent||h.innerText,o=r.dom.getAttrib(h,"href"),t.trim(a)||(a=n||""),i&&(l.test(i)||c.test(i))&&(o=i),"_wp_link_placeholder"!==o?(u.url.val(o),u.openInNewTab.prop("checked","_blank"===r.dom.getAttrib(h,"target")),u.submit.val(e.update)):this.setDefaultValues(a),i&&i!==o?u.search.val(i):u.search.val(""),window.setTimeout(function(){wpLink.searchInternalLinks()})):(a=r.selection.getContent({format:"text"})||n||"",this.setDefaultValues(a)),d?(u.text.val(a),u.wrap.addClass("has-text-field")):(u.text.val(""),u.wrap.removeClass("has-text-field"))},close:function(e){t(document.body).removeClass("modal-open"),wpLink.modalOpen=!1,"noReset"!==e&&(wpLink.isMCE()?(r.plugins.wplink&&r.plugins.wplink.close(),r.focus()):(wpLink.textarea.focus(),wpLink.range&&(wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select()))),u.backdrop.hide(),u.wrap.hide(),h=!1,t(document).trigger("wplink-close",u.wrap)},getAttrs:function(){return wpLink.correctURL(),{href:t.trim(u.url.val()),target:u.openInNewTab.prop("checked")?"_blank":null}},buildHtml:function(t){var e='<a href="'+t.href+'"';return t.target&&(e+=' rel="noopener" target="'+t.target+'"'),e+">"},update:function(){wpLink.isMCE()?wpLink.mceUpdate():wpLink.htmlUpdate()},htmlUpdate:function(){var s,r,n,a,o,h,d,c=wpLink.textarea;if(c){s=wpLink.getAttrs(),r=u.text.val();var l=document.createElement("a");l.href=s.href,"javascript:"!==l.protocol&&"data:"!==l.protocol||(s.href=""),s.href&&(n=wpLink.buildHtml(s),document.selection&&wpLink.range?(c.focus(),wpLink.range.text=n+(r||wpLink.range.text)+"</a>",wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select(),wpLink.range=null):"undefined"!=typeof c.selectionStart&&(a=c.selectionStart,o=c.selectionEnd,d=r||c.value.substring(a,o),n=n+d+"</a>",h=a+n.length,a!==o||d||(h-=4),c.value=c.value.substring(0,a)+n+c.value.substring(o,c.value.length),c.selectionStart=c.selectionEnd=h),wpLink.close(),c.focus(),t(c).trigger("change"),i.a11y.speak(e.linkInserted))}},mceUpdate:function(){var n,a,o,h,d=wpLink.getAttrs(),c=document.createElement("a");if(c.href=d.href,"javascript:"!==c.protocol&&"data:"!==c.protocol||(d.href=""),!d.href)return r.execCommand("unlink"),void wpLink.close();n=r.$(s()),r.undoManager.transact(function(){n.length||(r.execCommand("mceInsertLink",!1,{href:"_wp_link_placeholder","data-wp-temp-link":1}),n=r.$('a[data-wp-temp-link="1"]').removeAttr("data-wp-temp-link"),o=t.trim(n.text())),n.length?(u.wrap.hasClass("has-text-field")&&(a=u.text.val(),a?n.text(a):o||n.text(d.href)),d["data-wplink-edit"]=null,d["data-mce-href"]=null,n.attr(d)):r.execCommand("unlink")}),wpLink.close("noReset"),r.focus(),n.length&&(h=n.parent("#_mce_caret"),h.length&&h.before(n.removeAttr("data-mce-bogus")),r.selection.select(n[0]),r.selection.collapse(),r.plugins.wplink&&r.plugins.wplink.checkLink(n[0])),r.nodeChanged(),i.a11y.speak(e.linkInserted)},updateFields:function(t,e){u.url.val(e.children(".item-permalink").val())},getUrlFromSelection:function(e){return e||(this.isMCE()?e=r.selection.getContent({format:"text"}):document.selection&&wpLink.range?e=wpLink.range.text:"undefined"!=typeof this.textarea.selectionStart&&(e=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd))),e=t.trim(e),e&&c.test(e)?"mailto:"+e:e&&l.test(e)?e.replace(/&amp;|&#0?38;/gi,"&"):""},setDefaultValues:function(t){u.url.val(this.getUrlFromSelection(t)),u.search.val(""),wpLink.searchInternalLinks(),u.submit.val(e.save)},searchInternalLinks:function(){var t,e=u.search.val()||"";if(e.length>2){if(p.recent.hide(),p.search.show(),wpLink.lastSearch==e)return;wpLink.lastSearch=e,t=u.search.parent().find(".spinner").addClass("is-active"),p.search.change(e),p.search.ajax(function(){t.removeClass("is-active")})}else p.search.hide(),p.recent.show()},next:function(){p.search.next(),p.recent.next()},prev:function(){p.search.prev(),p.recent.prev()},keydown:function(t){var e,i;27===t.keyCode?(wpLink.close(),t.stopImmediatePropagation()):9===t.keyCode&&(i=t.target.id,"wp-link-submit"!==i||t.shiftKey?"wp-link-close"===i&&t.shiftKey&&(u.submit.focus(),t.preventDefault()):(u.close.focus(),t.preventDefault())),t.shiftKey||38!==t.keyCode&&40!==t.keyCode||(!document.activeElement||"link-title-field"!==document.activeElement.id&&"url-field"!==document.activeElement.id)&&(e=38===t.keyCode?"prev":"next",clearInterval(wpLink.keyInterval),wpLink[e](),wpLink.keyInterval=setInterval(wpLink[e],wpLink.keySensitivity),t.preventDefault())},keyup:function(t){38!==t.keyCode&&40!==t.keyCode||(clearInterval(wpLink.keyInterval),t.preventDefault())},delayedCallback:function(t,e){var i,s,r,n;return e?(setTimeout(function(){if(s)return t.apply(n,r);i=!0},e),function(){if(i)return t.apply(this,arguments);r=arguments,n=this,s=!0}):t}},a=function(e,i){var s=this;this.element=e,this.ul=e.children("ul"),this.contentHeight=e.children("#link-selector-height"),this.waiting=e.find(".river-waiting"),this.change(i),this.refresh(),t("#wp-link .query-results, #wp-link #link-selector").scroll(function(){s.maybeLoad()}),e.on("click","li",function(e){s.select(t(this),e)})},t.extend(a.prototype,{refresh:function(){this.deselect(),this.visible=this.element.is(":visible")},show:function(){this.visible||(this.deselect(),this.element.show(),this.visible=!0)},hide:function(){this.element.hide(),this.visible=!1},select:function(t,e){var i,s,r,n;t.hasClass("unselectable")||t==this.selected||(this.deselect(),this.selected=t.addClass("selected"),i=t.outerHeight(),s=this.element.height(),r=t.position().top,n=this.element.scrollTop(),r<0?this.element.scrollTop(n+r):r+i>s&&this.element.scrollTop(n+r-s+i),this.element.trigger("river-select",[t,e,this]))},deselect:function(){this.selected&&this.selected.removeClass("selected"),this.selected=!1},prev:function(){if(this.visible){var t;this.selected&&(t=this.selected.prev("li"),t.length&&this.select(t))}},next:function(){if(this.visible){var e=this.selected?this.selected.next("li"):t("li:not(.unselectable):first",this.element);e.length&&this.select(e)}},ajax:function(t){var e=this,i=1==this.query.page?0:wpLink.minRiverAJAXDuration,s=wpLink.delayedCallback(function(i,s){e.process(i,s),t&&t(i,s)},i);this.query.ajax(s)},change:function(t){this.query&&this._search==t||(this._search=t,this.query=new o(t),this.element.scrollTop(0))},process:function(i,s){var r="",n=!0,a="",o=1==s.page;i?t.each(i,function(){a=n?"alternate":"",a+=this.title?"":" no-title",r+=a?'<li class="'+a+'">':"<li>",r+='<input type="hidden" class="item-permalink" value="'+this.permalink+'" />',r+='<span class="item-title">',r+=this.title?this.title:e.noTitle,r+='</span><span class="item-info">'+this.info+"</span></li>",n=!n}):o&&(r+='<li class="unselectable no-matches-found"><span class="item-title"><em>'+e.noMatchesFound+"</em></span></li>"),this.ul[o?"html":"append"](r)},maybeLoad:function(){var t=this,e=this.element,i=e.scrollTop()+e.height();!this.query.ready()||i<this.contentHeight.height()-wpLink.riverBottomThreshold||setTimeout(function(){var i=e.scrollTop(),s=i+e.height();!t.query.ready()||s<t.contentHeight.height()-wpLink.riverBottomThreshold||(t.waiting.addClass("is-active"),e.scrollTop(i+t.waiting.outerHeight()),t.ajax(function(){t.waiting.removeClass("is-active")}))},wpLink.timeToTriggerRiver)}}),o=function(t){this.page=1,this.allLoaded=!1,this.querying=!1,this.search=t},t.extend(o.prototype,{ready:function(){return!(this.querying||this.allLoaded)},ajax:function(e){var i=this,s={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:u.nonce.val()};this.search&&(s.search=this.search),this.querying=!0,t.post(window.ajaxurl,s,function(t){i.page++,i.querying=!1,i.allLoaded=!t,e(t,s)},"json")}}),t(document).ready(wpLink.init)}(jQuery,window.wpLinkL10n,window.wp);