var wpWidgets;!function(t){var e=t(document);wpWidgets={hoveredSidebar:null,l10n:{save:"{save}",saved:"{saved}",saveAlert:"{saveAlert}",widgetAdded:"{widgetAdded}"},dirtyWidgets:{},init:function(){var i,s,r=this,n=t(".widgets-chooser"),a=n.find(".widgets-chooser-sidebars"),o=t("div.widgets-sortables"),h=!("undefined"==typeof isRtl||!isRtl);t("#widgets-right .sidebar-name").click(function(){var i=t(this),s=i.closest(".widgets-holder-wrap "),r=i.find(".handlediv");s.hasClass("closed")?(s.removeClass("closed"),r.attr("aria-expanded","true"),i.parent().sortable("refresh")):(s.addClass("closed"),r.attr("aria-expanded","false")),e.triggerHandler("wp-pin-menu")}).find(".handlediv").each(function(e){0!==e&&t(this).attr("aria-expanded","false")}),t(window).on("beforeunload.widgets",function(e){var i,s=[];if(t.each(r.dirtyWidgets,function(t,e){e&&s.push(t)}),0!==s.length)return i=t("#widgets-right").find(".widget").filter(function(){return-1!==s.indexOf(t(this).prop("id").replace(/^widget-\d+_/,""))}),i.each(function(){t(this).hasClass("open")||t(this).find(".widget-title-action:first").click()}),i.first().each(function(){this.scrollIntoViewIfNeeded?this.scrollIntoViewIfNeeded():this.scrollIntoView(),t(this).find(".widget-inside :tabbable:first").focus()}),e.returnValue=wpWidgets.l10n.saveAlert,e.returnValue}),t("#widgets-left .sidebar-name").click(function(){var i=t(this).closest(".widgets-holder-wrap");i.toggleClass("closed").find(".handlediv").attr("aria-expanded",!i.hasClass("closed")),e.triggerHandler("wp-pin-menu")}),t(document.body).bind("click.widgets-toggle",function(e){var i,s,n,a,o,d,c,l=t(e.target),u={"z-index":100},p=l.closest(".widget").find(".widget-top button.widget-action");l.parents(".widget-top").length&&!l.parents("#available-widgets").length?(i=l.closest("div.widget"),s=i.children(".widget-inside"),n=parseInt(i.find("input.widget-width").val(),10),a=i.parent().width(),c=s.find(".widget-id").val(),i.data("dirty-state-initialized")||(d=s.find(".widget-control-save"),d.prop("disabled",!0).val(wpWidgets.l10n.saved),s.on("input change",function(){r.dirtyWidgets[c]=!0,i.addClass("widget-dirty"),d.prop("disabled",!1).val(wpWidgets.l10n.save)}),i.data("dirty-state-initialized",!0)),s.is(":hidden")?(n>250&&n+30>a&&i.closest("div.widgets-sortables").length&&(o=i.closest("div.widget-liquid-right").length?h?"margin-right":"margin-left":h?"margin-left":"margin-right",u[o]=a-(n+30)+"px",i.css(u)),p.attr("aria-expanded","true"),s.slideDown("fast",function(){i.addClass("open")})):(p.attr("aria-expanded","false"),s.slideUp("fast",function(){i.attr("style",""),i.removeClass("open")}))):l.hasClass("widget-control-save")?(wpWidgets.save(l.closest("div.widget"),0,1,0),e.preventDefault()):l.hasClass("widget-control-remove")?wpWidgets.save(l.closest("div.widget"),1,1,0):l.hasClass("widget-control-close")?(i=l.closest("div.widget"),i.removeClass("open"),p.attr("aria-expanded","false"),wpWidgets.close(i)):"inactive-widgets-control-remove"===l.attr("id")&&(wpWidgets.removeInactiveWidgets(),e.preventDefault())}),o.children(".widget").each(function(){var e=t(this);wpWidgets.appendTitle(this),e.find("p.widget-error").length&&e.find(".widget-action").trigger("click").attr("aria-expanded","true")}),t("#widget-list").children(".widget").draggable({connectToSortable:"div.widgets-sortables",handle:"> .widget-top > .widget-title",distance:2,helper:"clone",zIndex:100,containment:"#wpwrap",refreshPositions:!0,start:function(e,i){var n=t(this).find(".widgets-chooser");i.helper.find("div.widget-description").hide(),s=this.id,n.length&&(t("#wpbody-content").append(n.hide()),i.helper.find(".widgets-chooser").remove(),r.clearWidgetSelection())},stop:function(){i&&t(i).hide(),i=""}}),o.droppable({tolerance:"intersect",over:function(e){var i=t(e.target).parent();wpWidgets.hoveredSidebar&&!i.is(wpWidgets.hoveredSidebar)&&wpWidgets.closeSidebar(e),i.hasClass("closed")&&(wpWidgets.hoveredSidebar=i,i.removeClass("closed").find(".handlediv").attr("aria-expanded","true")),t(this).sortable("refresh")},out:function(t){wpWidgets.hoveredSidebar&&wpWidgets.closeSidebar(t)}}),o.sortable({placeholder:"widget-placeholder",items:"> .widget",handle:"> .widget-top > .widget-title",cursor:"move",distance:2,containment:"#wpwrap",tolerance:"pointer",refreshPositions:!0,start:function(e,i){var s,r=t(this),n=r.parent(),a=i.item.children(".widget-inside");"block"===a.css("display")&&(i.item.removeClass("open"),i.item.find(".widget-top button.widget-action").attr("aria-expanded","false"),a.hide(),t(this).sortable("refreshPositions")),n.hasClass("closed")||(s=i.item.hasClass("ui-draggable")?r.height():1+r.height(),r.css("min-height",s+"px"))},stop:function(r,n){var a,o,h,d,c,l,u=n.item,p=s;if(wpWidgets.hoveredSidebar=null,u.hasClass("deleting"))return wpWidgets.save(u,1,0,1),void u.remove();a=u.find("input.add_new").val(),o=u.find("input.multi_number").val(),u.attr("style","").removeClass("ui-draggable"),s="",a&&("multi"===a?(u.html(u.html().replace(/<[^<>]+>/g,function(t){return t.replace(/__i__|%i%/g,o)})),u.attr("id",p.replace("__i__",o)),o++,t("div#"+p).find("input.multi_number").val(o)):"single"===a&&(u.attr("id","new-"+p),i="div#"+p),wpWidgets.save(u,0,0,1),u.find("input.add_new").val(""),e.trigger("widget-added",[u])),h=u.parent(),h.parent().hasClass("closed")&&(h.parent().removeClass("closed").find(".handlediv").attr("aria-expanded","true"),d=h.children(".widget"),d.length>1&&(c=d.get(0),l=u.get(0),c.id&&l.id&&c.id!==l.id&&t(c).before(u))),a?u.find(".widget-action").trigger("click"):wpWidgets.saveOrder(h.attr("id"))},activate:function(){t(this).parent().addClass("widget-hover")},deactivate:function(){t(this).css("min-height","").parent().removeClass("widget-hover")},receive:function(e,i){var s=t(i.sender);if(this.id.indexOf("orphaned_widgets")>-1)return void s.sortable("cancel");s.attr("id").indexOf("orphaned_widgets")>-1&&!s.children(".widget").length&&s.parents(".orphan-sidebar").slideUp(400,function(){t(this).remove()})}}).sortable("option","connectWith","div.widgets-sortables"),t("#available-widgets").droppable({tolerance:"pointer",accept:function(e){return"widget-list"!==t(e).parent().attr("id")},drop:function(e,i){i.draggable.addClass("deleting"),t("#removing-widget").hide().children("span").empty()},over:function(e,i){i.draggable.addClass("deleting"),t("div.widget-placeholder").hide(),i.draggable.hasClass("ui-sortable-helper")&&t("#removing-widget").show().children("span").html(i.draggable.find("div.widget-title").children("h3").html())},out:function(e,i){i.draggable.removeClass("deleting"),t("div.widget-placeholder").show(),t("#removing-widget").hide().children("span").empty()}}),t("#widgets-right .widgets-holder-wrap").each(function(e,i){var s=t(i),r=s.find(".sidebar-name h2").text(),n=s.find(".sidebar-name").data("add-to"),o=s.find(".widgets-sortables").attr("id"),h=t("<li>"),d=t("<button>",{type:"button","aria-pressed":"false","class":"widgets-chooser-button","aria-label":n}).text(t.trim(r));h.append(d),0===e&&(h.addClass("widgets-chooser-selected"),d.attr("aria-pressed","true")),a.append(h),h.data("sidebarId",o)}),t("#available-widgets .widget .widget-top").on("click.widgets-chooser",function(){var e=t(this).closest(".widget"),i=t(this).find(".widget-action"),s=a.find(".widgets-chooser-button");e.hasClass("widget-in-question")||t("#widgets-left").hasClass("chooser")?(i.attr("aria-expanded","false"),r.closeChooser()):(r.clearWidgetSelection(),t("#widgets-left").addClass("chooser"),e.addClass("widget-in-question").children(".widget-description").after(n),n.slideDown(300,function(){i.attr("aria-expanded","true")}),s.on("click.widgets-chooser",function(){a.find(".widgets-chooser-selected").removeClass("widgets-chooser-selected"),s.attr("aria-pressed","false"),t(this).attr("aria-pressed","true").closest("li").addClass("widgets-chooser-selected")}))}),n.on("click.widgets-chooser",function(e){var i=t(e.target);i.hasClass("button-primary")?(r.addWidget(n),r.closeChooser()):i.hasClass("widgets-chooser-cancel")&&r.closeChooser()}).on("keyup.widgets-chooser",function(e){e.which===t.ui.keyCode.ESCAPE&&r.closeChooser()})},saveOrder:function(e){var i={action:"widgets-order",savewidgets:t("#_wpnonce_widgets").val(),sidebars:[]};e&&t("#"+e).find(".spinner:first").addClass("is-active"),t("div.widgets-sortables").each(function(){t(this).sortable&&(i["sidebars["+t(this).attr("id")+"]"]=t(this).sortable("toArray").join(","))}),t.post(ajaxurl,i,function(){t("#inactive-widgets-control-remove").prop("disabled",!t("#wp_inactive_widgets .widget").length),t(".spinner").removeClass("is-active")})},save:function(i,s,r,n){var a,o,h=this,d=i.closest("div.widgets-sortables").attr("id"),c=i.find("form"),l=i.find("input.add_new").val();(s||l||!c.prop("checkValidity")||c[0].checkValidity())&&(a=c.serialize(),i=t(i),t(".spinner",i).addClass("is-active"),o={action:"save-widget",savewidgets:t("#_wpnonce_widgets").val(),sidebar:d},s&&(o.delete_widget=1),a+="&"+t.param(o),t.post(ajaxurl,a,function(a){var o=t("input.widget-id",i).val();s?(t("input.widget_number",i).val()||t("#available-widgets").find("input.widget-id").each(function(){t(this).val()===o&&t(this).closest("div.widget").show()}),r?(n=0,i.slideUp("fast",function(){t(this).remove(),wpWidgets.saveOrder(),delete h.dirtyWidgets[o]})):(i.remove(),delete h.dirtyWidgets[o],"wp_inactive_widgets"===d&&t("#inactive-widgets-control-remove").prop("disabled",!t("#wp_inactive_widgets .widget").length))):(t(".spinner").removeClass("is-active"),a&&a.length>2&&(t("div.widget-content",i).html(a),wpWidgets.appendTitle(i),i.find(".widget-control-save").prop("disabled",!0).val(wpWidgets.l10n.saved),i.removeClass("widget-dirty"),delete h.dirtyWidgets[o],e.trigger("widget-updated",[i]),"wp_inactive_widgets"===d&&t("#inactive-widgets-control-remove").prop("disabled",!t("#wp_inactive_widgets .widget").length))),n&&wpWidgets.saveOrder()}))},removeInactiveWidgets:function(){var e,i,s=t(".remove-inactive-widgets"),r=this;t(".spinner",s).addClass("is-active"),e={action:"delete-inactive-widgets",removeinactivewidgets:t("#_wpnonce_remove_inactive_widgets").val()},i=t.param(e),t.post(ajaxurl,i,function(){t("#wp_inactive_widgets .widget").each(function(){var e=t(this);delete r.dirtyWidgets[e.find("input.widget-id").val()],e.remove()}),t("#inactive-widgets-control-remove").prop("disabled",!0),t(".spinner",s).removeClass("is-active")})},appendTitle:function(e){var i=t('input[id*="-title"]',e).val()||"";i&&(i=": "+i.replace(/<[^<>]+>/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;")),t(e).children(".widget-top").children(".widget-title").children().children(".in-widget-title").html(i)},close:function(t){t.children(".widget-inside").slideUp("fast",function(){t.attr("style","").find(".widget-top button.widget-action").attr("aria-expanded","false").focus()})},addWidget:function(i){var s,r,n,a,o,h,d,c=i.find(".widgets-chooser-selected").data("sidebarId"),l=t("#"+c);s=t("#available-widgets").find(".widget-in-question").clone(),r=s.attr("id"),n=s.find("input.add_new").val(),a=s.find("input.multi_number").val(),s.find(".widgets-chooser").remove(),"multi"===n?(s.html(s.html().replace(/<[^<>]+>/g,function(t){return t.replace(/__i__|%i%/g,a)})),s.attr("id",r.replace("__i__",a)),a++,t("#"+r).find("input.multi_number").val(a)):"single"===n&&(s.attr("id","new-"+r),t("#"+r).hide()),l.closest(".widgets-holder-wrap").removeClass("closed").find(".handlediv").attr("aria-expanded","true"),l.append(s),l.sortable("refresh"),wpWidgets.save(s,0,0,1),s.find("input.add_new").val(""),e.trigger("widget-added",[s]),o=t(window).scrollTop(),h=o+t(window).height(),d=l.offset(),d.bottom=d.top+l.outerHeight(),(o>d.bottom||h<d.top)&&t("html, body").animate({scrollTop:d.top-130},200),window.setTimeout(function(){s.find(".widget-title").trigger("click"),window.wp.a11y.speak(wpWidgets.l10n.widgetAdded,"assertive")},250)},closeChooser:function(){var e=this,i=t("#available-widgets .widget-in-question");t(".widgets-chooser").slideUp(200,function(){t("#wpbody-content").append(this),e.clearWidgetSelection(),i.find(".widget-action").attr("aria-expanded","false").focus()})},clearWidgetSelection:function(){t("#widgets-left").removeClass("chooser"),t(".widget-in-question").removeClass("widget-in-question")},closeSidebar:function(e){this.hoveredSidebar.addClass("closed").find(".handlediv").attr("aria-expanded","false"),t(e.target).css("min-height",""),this.hoveredSidebar=null}},e.ready(function(){wpWidgets.init()})}(jQuery);